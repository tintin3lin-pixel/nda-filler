<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NDA ä¸€é”®å¡«å……ï¼ˆæ‰‹æœºå¯ç”¨ï¼‰</title>
  <style>
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans SC", "PingFang SC", "Microsoft Yahei", sans-serif; margin:0; background:#0a0014; color:#e6e6e6}
    .wrap{max-width:960px; margin:0 auto; padding:20px}
    h1{font-size:22px; margin:0 0 12px}
    .card{background:#1e1e1e; border-radius:16px; padding:16px; margin:12px 0; box-shadow:0 8px 30px rgba(0,0,0,.25)}
    label{display:block; font-size:14px; opacity:.9; margin-bottom:8px}
    input[type=file], textarea, select {width:100%; background:#0a0014; color:#e6e6e6; border:1px solid #5a00ff55; border-radius:12px; padding:12px; box-sizing:border-box}
    textarea{min-height:160px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:13px}
    .row{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:720px){.row{grid-template-columns:1fr 1fr}}
    .btn{cursor:pointer; border:0; border-radius:14px; padding:12px 16px; font-weight:600; background-image:linear-gradient(135deg,#5A00FF,#E500FF,#00D1FF); color:#0a0014}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .muted{opacity:.75; font-size:13px}
    .badge{display:inline-block; padding:4px 10px; border-radius:999px; background:#00d1ff22; border:1px solid #00d1ff66; color:#e6e6e6; font-size:12px; margin-right:8px}
    .ok{background:#00d1ff22; border-color:#00d1ff66}
    .warn{background:#ff6b0022; border-color:#ff6b0066}
    .err{background:#ff003322; border-color:#ff003366}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px}
    .footer{opacity:.7; font-size:12px; text-align:center; margin-top:12px}
  </style>
  <!-- libs for docx read/write in browser -->
  <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js"></script>
  <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip-utils.min.js"></script>
  <script src="https://unpkg.com/docxtemplater@3.44.0/build/docxtemplater.js"></script>
  <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“„ NDA ä¸€é”®å¡«å……ï¼ˆæ‰‹æœºå¯ç”¨ã€ç¦»çº¿è¿è¡Œï¼‰</h1>
    <div class="card">
      <p class="muted">æŠŠæŠ•èµ„äºº/åˆä½œæ–¹å‘æ¥çš„ <b>DOCX æ¨¡æ¿</b> å’Œ <b>å…¬å¸ä¿¡æ¯</b> ä½œä¸ºè¾“å…¥ï¼›è‡ªåŠ¨å¡«å…¬å¸åç§°ã€æ³•å®šä»£è¡¨äººã€ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ã€åœ°å€ã€å½“å¤©æ—¥æœŸç­‰ï¼Œå¹¶ <b>æ£€æµ‹ä¿å¯†æœŸé™æ˜¯å¦ â‰¥ 2 å¹´</b>ã€‚<br/>æ”¯æŒä¸¤ç§æ–¹å¼ï¼š
        <span class="badge">æ¨¡æ¿å ä½ç¬¦æ¨¡å¼</span>
        <span class="badge">æ™ºèƒ½æ›¿æ¢æ¨¡å¼ï¼ˆæ— å ä½ç¬¦ï¼‰</span>
      </p>
      <div class="row">
        <div>
          <label>1) ä¸Šä¼  NDA æ¨¡æ¿ï¼ˆä»… .docxï¼‰</label>
          <input type="file" id="file" accept=".docx" />
        </div>
        <div>
          <label>2) å…¬å¸ä¿¡æ¯ï¼ˆJSON æˆ– YAMLï¼Œç¤ºä¾‹è§ä¸‹ï¼‰</label>
          <textarea id="data" placeholder='{
  "company_name": "ä¼—ç¦¾æ–°ææ–™ï¼ˆå¹¿å·ï¼‰æœ‰é™å…¬å¸",
  "legal_rep": "å¼ ä¸‰",
  "usc_code": "91440101MA5XXXXXXX",
  "address": "å¹¿å·å¸‚é»„åŸ”åŒºç§‘å­¦å¤§é“ 99 å·",
  "contact_name": "æå››",
  "contact_email": "lisa@example.com",
  "contact_phone": "+86 138 0000 0000",
  "party_role": "ä¹™æ–¹"  
}'></textarea>
        </div>
      </div>
      <div class="row">
        <div>
          <label>3) é€‰æ‹©å·¥ä½œæ¨¡å¼</label>
          <select id="mode">
            <option value="template">æ¨¡æ¿å ä½ç¬¦æ¨¡å¼ï¼ˆæ¨èï¼‰</option>
            <option value="smart">æ™ºèƒ½æ›¿æ¢æ¨¡å¼ï¼ˆå¸¸è§æ ‡ç­¾è¯†åˆ«ï¼‰</option>
          </select>
        </div>
        <div>
          <label>4) æ—¥æœŸæ ¼å¼</label>
          <select id="datefmt">
            <option value="YYYYå¹´MæœˆDæ—¥">YYYYå¹´MæœˆDæ—¥</option>
            <option value="YYYY-MM-DD">YYYY-MM-DD</option>
            <option value="YYYY/MM/DD">YYYY/MM/DD</option>
          </select>
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap">
        <button class="btn" id="run">ğŸš€ ä¸€é”®å¡«å……å¹¶ä¸‹è½½</button>
        <button class="btn" id="demo">âš™ï¸ ç”Ÿæˆç¤ºä¾‹æ¨¡æ¿</button>
      </div>
      <div id="status" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <b>å ä½ç¬¦å‘½åå»ºè®®ï¼ˆæ¨¡æ¿æ¨¡å¼ï¼‰ï¼š</b>
      <pre class="mono">{{company_name}}  {{legal_rep}}  {{usc_code}}  {{address}}
{{contact_name}}  {{contact_email}}  {{contact_phone}}  {{party_role}}
{{today}} ï¼ˆä¼šè‡ªåŠ¨å¡«å…¥ä»Šæ—¥æ—¥æœŸï¼‰</pre>
      <p class="muted">æŠŠä»¥ä¸Šå ä½ç¬¦æ”¾è¿›ä½ çš„ NDA DOCX æ¨¡æ¿å³å¯ï¼›é¦–æ¬¡ç”¨æ—¶å»ºè®®è®©å¯¹æ–¹æä¾› Word ç‰ˆï¼Œæˆ–è‡ªè¡ŒæŠŠ PDF è½¬ä¸º Word å†å¤„ç†ã€‚</p>
      <b>æ™ºèƒ½æ›¿æ¢æ”¯æŒçš„å¸¸è§ä¸­æ–‡æ ‡ç­¾ï¼ˆæ— éœ€å ä½ç¬¦ï¼‰ï¼š</b>
      <pre class="mono">å…¬å¸åç§° / åç§° / å•ä½åç§°
æ³•å®šä»£è¡¨äºº / æ³•äºº
ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç  / ä¿¡ç”¨ä»£ç  / ç»Ÿä¸€ç¤¾ä¼šä»£ç 
åœ°å€ / æ³¨å†Œåœ°å€ / é€šè®¯åœ°å€
è”ç³»äºº / è”ç³»ç”µè¯ / é‚®ç®±
æŠ«éœ²æ–¹ / æ¥æ”¶æ–¹ / ç”²æ–¹ / ä¹™æ–¹
æ—¥æœŸï¼ˆè‡ªåŠ¨å¡«å…¥ä»Šæ—¥ï¼‰
ä¿å¯†æœŸé™ / ä¿å¯†æœŸï¼ˆè‡ªåŠ¨æ£€æµ‹ â‰¥ 2 å¹´ï¼‰</pre>
    </div>

    <div class="footer">Â© chouchou ai Â· æœ¬é¡µé¢å®Œå…¨æœ¬åœ°è¿è¡Œï¼Œä¸ä¸Šä¼ æ–‡ä»¶ï¼›å¦‚éœ€é«˜çº§è¯†åˆ«æˆ– PDF è¡¨å•ï¼Œè¯·åç»­æ‰©å±•ã€‚</div>
  </div>

<script>
// --- tiny YAML parser fallback ---
function parseData(text){
  try { return JSON.parse(text) } catch(e) {}
  // naive YAML (key: value per line)
  const obj={};
  text.split(/\r?\n/).forEach(line=>{
    const m=line.match(/^\s*([A-Za-z0-9_]+)\s*:\s*(.*)$/);
    if(m){ obj[m[1].trim()]=m[2].trim().replace(/^"|"$/g,'').replace(/^'|'$/g,''); }
  });
  return obj;
}

function fmtToday(fmt){
  const d=new Date();
  const Y=d.getFullYear();
  const M=d.getMonth()+1;
  const D=d.getDate();
  return fmt.replace('YYYY', Y).replace('MM', String(M).padStart(2,'0')).replace('DD', String(D).padStart(2,'0'))
            .replace('M', M).replace('D', D);
}

function report(msg, type='ok'){
  const el=document.getElementById('status');
  el.innerHTML = `<div class="badge ${type}">${msg}</div>`;
}

function readDocxAsZip(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload = e=>{
      try{ resolve(new PizZip(e.target.result)); }
      catch(err){ reject(err); }
    };
    reader.onerror = reject;
    reader.readAsBinaryString(file);
  });
}

function saveDocx(zip, outName){
  const blob=zip.generate({type:"blob", mimeType:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"});
  saveAs(blob, outName);
}

function smartReplaceXML(xml, data, dateStr){
  const patterns=[
    {keys:['å…¬å¸åç§°','åç§°','å•ä½åç§°'], field:'company_name'},
    {keys:['æ³•å®šä»£è¡¨äºº','æ³•äºº'], field:'legal_rep'},
    {keys:['ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ','ä¿¡ç”¨ä»£ç ','ç»Ÿä¸€ç¤¾ä¼šä»£ç '], field:'usc_code'},
    {keys:['åœ°å€','æ³¨å†Œåœ°å€','é€šè®¯åœ°å€'], field:'address'},
    {keys:['è”ç³»äºº'], field:'contact_name'},
    {keys:['è”ç³»ç”µè¯','ç”µè¯','è”ç³»æ–¹å¼'], field:'contact_phone'},
    {keys:['é‚®ç®±','ç”µå­é‚®ç®±'], field:'contact_email'},
    {keys:['æŠ«éœ²æ–¹','ç”²æ–¹'], field:'discloser', fallback:'company_name'},
    {keys:['æ¥æ”¶æ–¹','ä¹™æ–¹'], field:'receiver', fallback:'company_name'},
  ];
  // Replace values after label, handling separators like ï¼š: ã€ ç©ºæ ¼ ä»¥åŠä¸‹åˆ’çº¿å ä½
  patterns.forEach(p=>{
    const val = data[p.field] || (p.fallback ? data[p.fallback] : '');
    if(!val) return;
    p.keys.forEach(k=>{
      const re=new RegExp(`(${k}\s*[ï¼š:]?\s*)(?:[_ã€€\u3000\s]{2,}|[^\n<]{0,40})`, 'g');
      xml = xml.replace(re, `$1${val}`);
    });
  });
  // today
  xml = xml.replace(/(æ—¥æœŸ\s*[ï¼š:]?\s*)(?:[_ã€€\u3000\s]{2,}|[^\n<]{0,20})/g, `$1${dateStr}`);
  return xml;
}

function extractTextForTermCheck(xml){
  // strip xml tags
  const text = xml.replace(/<[^>]+>/g,'');
  return text;
}

function checkConfidentialTerm(text){
  // Look for ä¿å¯†æœŸé™ / ä¿å¯†æœŸ followed by number + å¹´/æœˆ/å¤©
  const m = text.match(/ä¿å¯†(?:æœŸé™|æœŸ)[^\d]{0,10}(\d{1,3})(å¹´|ä¸ªæœˆ|æœˆ|å¤©|æ—¥)/);
  if(!m) return {found:false, ok:null, raw:null};
  const n = parseInt(m[1],10);
  let years = 0;
  if(m[2]==='å¹´'){ years = n; }
  else if(m[2]==='ä¸ªæœˆ' || m[2]==='æœˆ'){ years = n/12; }
  else { years = n/365; }
  return {found:true, ok: years>=2, raw: `${n}${m[2]} â‰ˆ ${years.toFixed(2)}å¹´`};
}

async function run(){
  const file = document.getElementById('file').files[0];
  if(!file){ report('è¯·å…ˆé€‰æ‹© .docx æ–‡ä»¶','err'); return; }
  const dataRaw = document.getElementById('data').value.trim();
  const data = parseData(dataRaw);
  data.today = fmtToday(document.getElementById('datefmt').value);
  const mode = document.getElementById('mode').value;

  try{
    const zip = await readDocxAsZip(file);
    if(mode==='template'){
      const doc = new window.docxtemplater().loadZip(zip);
      doc.setData(data);
      try { doc.render(); }
      catch(e){
        console.error(e);
        report('æ¨¡æ¿æ¨¡å¼æ¸²æŸ“å¤±è´¥ï¼šè¯·æ£€æŸ¥å ä½ç¬¦å‘½åæˆ–æ–‡æ¡£æ˜¯å¦è¢«åŠ å¯†','err');
        return;
      }
      const out=doc.getZip();
      saveDocx(out, file.name.replace(/\.docx$/i,'')+"_å·²å¡«å…….docx");
      // term check (best-effort): read xml and evaluate
      try{
        const xml = out.file('word/document.xml').asText();
        const t = extractTextForTermCheck(xml);
        const r = checkConfidentialTerm(t);
        if(r.found){
          report(r.ok ? `âœ” ä¿å¯†æœŸé™æ£€æµ‹ï¼šé€šè¿‡ï¼ˆ${r.raw}ï¼‰` : `âš  ä¿å¯†æœŸé™å¯èƒ½ä¸è¶³ 2 å¹´ï¼ˆ${r.raw}ï¼‰` , r.ok? 'ok':'warn');
        }else{
          report('â„¹ æœªåœ¨æ–‡æ¡£ä¸­è¯†åˆ«åˆ°â€œä¿å¯†æœŸé™/ä¿å¯†æœŸâ€ï¼Œè¯·äººå·¥å¤æ ¸','warn');
        }
      }catch(err){ report('å·²å¯¼å‡ºï¼›æœ¯è¯­æ£€æµ‹å¤±è´¥ï¼ˆè¯»å–æ–‡æœ¬å‡ºé”™ï¼‰','warn'); }
    } else {
      // smart mode: manipulate XML directly
      let xml = zip.file('word/document.xml').asText();
      xml = smartReplaceXML(xml, data, data.today);
      zip.file('word/document.xml', xml);
      saveDocx(zip, file.name.replace(/\.docx$/i,'')+"_æ™ºèƒ½å¡«å…….docx");
      const t = extractTextForTermCheck(xml);
      const r = checkConfidentialTerm(t);
      if(r.found){
        report(r.ok ? `âœ” ä¿å¯†æœŸé™æ£€æµ‹ï¼šé€šè¿‡ï¼ˆ${r.raw}ï¼‰` : `âš  ä¿å¯†æœŸé™å¯èƒ½ä¸è¶³ 2 å¹´ï¼ˆ${r.raw}ï¼‰` , r.ok? 'ok':'warn');
      }else{
        report('â„¹ æœªåœ¨æ–‡æ¡£ä¸­è¯†åˆ«åˆ°â€œä¿å¯†æœŸé™/ä¿å¯†æœŸâ€ï¼Œè¯·äººå·¥å¤æ ¸','warn');
      }
    }
  }catch(err){
    console.error(err);
    report('è¯»å–/å¤„ç† DOCX å¤±è´¥ï¼šè¯·ç¡®è®¤ä¸æ˜¯æ—§ç‰ˆ .doc æˆ–å—ä¿æŠ¤æ–‡ä»¶','err');
  }
}

async function generateDemo(){
  // Create a minimal demo .docx with placeholders
  const demoXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
    <w:body>
      <w:p><w:r><w:t>NDA ç¤ºä¾‹ï¼ˆæ¨¡æ¿å ä½ç¬¦æ¨¡å¼ï¼‰</w:t></w:r></w:p>
      <w:p><w:r><w:t>æŠ«éœ²æ–¹ï¼š{{company_name}}</w:t></w:r></w:p>
      <w:p><w:r><w:t>æ¥æ”¶æ–¹ï¼š{{party_role}}</w:t></w:r></w:p>
      <w:p><w:r><w:t>æ³•å®šä»£è¡¨äººï¼š{{legal_rep}}</w:t></w:r></w:p>
      <w:p><w:r><w:t>ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ï¼š{{usc_code}}</w:t></w:r></w:p>
      <w:p><w:r><w:t>åœ°å€ï¼š{{address}}</w:t></w:r></w:p>
      <w:p><w:r><w:t>è”ç³»äººï¼š{{contact_name}}ï¼ˆ{{contact_phone}} / {{contact_email}}ï¼‰</w:t></w:r></w:p>
      <w:p><w:r><w:t>ä¿å¯†æœŸé™ä¸º 3 å¹´ï¼Œè‡ªç­¾ç½²ä¹‹æ—¥èµ·è®¡ç®—ã€‚</w:t></w:r></w:p>
      <w:p><w:r><w:t>æ—¥æœŸï¼š{{today}}</w:t></w:r></w:p>
    </w:body>
  </w:document>`;
  const zip = new PizZip();
  zip.file("[Content_Types].xml", `<?xml version="1.0" encoding="UTF-8"?>
    <Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
      <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
      <Default Extension="xml" ContentType="application/xml"/>
      <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
    </Types>`);
  zip.folder("_rels").file(".rels", `<?xml version="1.0" encoding="UTF-8"?>
    <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
      <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="/word/document.xml"/>
    </Relationships>`);
  zip.folder("word").file("document.xml", demoXml);
  saveDocx(zip, 'NDA_ç¤ºä¾‹æ¨¡æ¿.docx');
}

document.getElementById('run').addEventListener('click', run);

document.getElementById('demo').addEventListener('click', generateDemo);
</script>
</body>
</html>
